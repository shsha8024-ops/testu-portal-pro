<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>قراءة QR — نسخة Vue + Altcha</title>

  <!-- Bootstrap (CSS فقط) + Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    body { background:#f8fafc }
    .app-card { background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    .video-wrap { position:relative; overflow:hidden; border-radius:12px; background:#000 }
    video { width:100%; height:auto; display:block; }
    .scan-frame {
      position:absolute; inset:8%;
      border:3px solid #0d6efd; border-radius:12px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      pointer-events:none;
    }
    .status { min-height: 48px }
    pre#qrText { direction:ltr; white-space:pre-wrap; word-break:break-all; background:#f1f3f5; padding:12px; border-radius:8px }
    .small-muted { font-size:.9rem; color:#6c757d }
  </style>
</head>
<body>
  <nav class="navbar bg-body-tertiary">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="https://ur.gov.iq/">
        <img src="https://ur.gov.iq/static-img/ar-ur-logo.png" alt="UR" style="height:32px">
        <span>منصة أور</span>
      </a>
    </div>
  </nav>

  <main id="app" class="container my-4">
    <div class="row g-4 align-items-stretch">
      <div class="col-lg-6">
        <div class="p-3 p-md-4 app-card h-100">
          <h1 class="h4 mb-3">قراءة رمز QR</h1>

          <!-- Altcha -->
          <div class="mb-3">
            <altcha-widget id="altcha"
              challengeurl="https://xdata.ur.gov.iq/api/auth/challenge"
              hidefooter="true" hidelogo="true" spamfilter="false"
              strings='{"label":"أنا أحب العراق","verifying":"جاري التحقق...","verified":"تم التحقق","error":"خطأ في التحقق"}'>
            </altcha-widget>
            <div class="small-muted mt-2">
              لنبدأ بشكل آمن: فعّل التحقق ثم سيصبح زر البدء متاحًا.
            </div>
          </div>

          <div class="video-wrap ratio ratio-4x3 mb-3">
            <video id="video" playsinline autoplay muted></video>
            <div class="scan-frame" v-show="isScanning"></div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary" :disabled="!isVerified || isScanning" @click="startScan">
              <i class="bi bi-camera-video"></i> ابدأ المسح
            </button>
            <button class="btn btn-secondary" :disabled="!isScanning" @click="stopScan">
              <i class="bi bi-stop-circle"></i> إيقاف
            </button>
          </div>

          <div class="status mt-3">
            <template v-if="error">
              <div class="alert alert-danger mb-2">{{ error }}</div>
            </template>
            <template v-else-if="isScanning">
              <div class="text-muted">جاري المسح… وجّه الكاميرا نحو الرمز.</div>
            </template>
            <template v-else-if="qrText">
              <div class="alert alert-success mb-2">تمت القراءة بنجاح:</div>
            </template>
          </div>

          <pre id="qrText" v-if="qrText">{{ qrText }}</pre>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="p-3 p-md-4 app-card h-100">
          <h2 class="h5">ملاحظات تشغيل سريعة</h2>
          <ul class="mt-3">
            <li>تحتاج الصفحة إلى <strong>HTTPS</strong> أو <code>localhost</code> للسماح للكاميرا بالعمل.</li>
            <li>نستخدم <code>jsQR</code> للقراءة مع كاميرات تدعم واجهة <code>getUserMedia</code>.</li>
            <li>إذا التقط نصًّا يبدأ بـ <code>http</code> ستظهر وصلة للفتح.</li>
          </ul>
          <div class="small-muted">
            يعمل على المتصفحات الحديثة في الهواتف والأجهزة المكتبية. في بعض الأجهزة قد تحتاج لمنح إذن الكاميرا يدويًا من إعدادات المتصفح.
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- jsQR (من دون وحدات) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- Altcha (UMD) لتسجيل عنصر altcha-widget -->
  <script src="https://cdn.jsdelivr.net/npm/altcha/dist/altcha.umd.js"></script>

  <!-- Bootstrap JS (اختياري لزر/مكونات أخرى) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  const { createApp, ref, onMounted, onBeforeUnmount } = Vue;

  createApp({
    setup() {
      const isVerified = ref(false);
      const isScanning = ref(false);
      const qrText = ref('');
      const error = ref('');
      const streamRef = ref(null);
      const rafId = ref(0);
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const video = document.getElementById('video');

      const startScan = async () => {
        error.value = '';
        qrText.value = '';

        try {
          // اطلب كاميرا الخلف إن توفرت
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' } },
            audio: false
          });
          streamRef.value = stream;
          video.srcObject = stream;
          await video.play();
          isScanning.value = true;
          tick();
        } catch (e) {
          error.value = 'تعذر فتح الكاميرا: ' + (e && (e.name || e.message) || e);
        }
      };

      const stopScan = () => {
        isScanning.value = false;
        if (rafId.value) cancelAnimationFrame(rafId.value);
        if (streamRef.value) {
          streamRef.value.getTracks().forEach(t => t.stop());
          streamRef.value = null;
        }
      };

      function tick() {
        if (!isScanning.value) return;

        const w = video.videoWidth;
        const h = video.videoHeight;
        if (w && h) {
          canvas.width = w;
          canvas.height = h;
          ctx.drawImage(video, 0, 0, w, h);
          const img = ctx.getImageData(0, 0, w, h);
          try {
            const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
            if (code && code.data) {
              qrText.value = code.data;
              // خيار: أوقف بعد أول قراءة
              stopScan();
              // إذا كان نصًا شبيهًا بالرابط، أعرض زر فتح
              // (نكتفي بإظهار النص، والمتصفح سيتعرّف على الرابط تلقائيًا إن كان في تطبيقك SPA).
            }
          } catch (e) {
            // تجاهل أخطاء jsQR في الإطارات الفارغة
          }
        }
        rafId.value = requestAnimationFrame(tick);
      }

      onMounted(() => {
        // اربط أحداث Altcha
        const altcha = document.getElementById('altcha');
        if (altcha) {
          altcha.addEventListener('verified', () => { isVerified.value = true; });
          altcha.addEventListener('error', () => { isVerified.value = false; });
          altcha.addEventListener('reset', () => { isVerified.value = false; });
        }

        // تنظيف عند إغلاق الصفحة
        window.addEventListener('pagehide', stopScan);
        window.addEventListener('beforeunload', stopScan);
      });

      onBeforeUnmount(() => stopScan());

      return { isVerified, isScanning, qrText, error, startScan, stopScan };
    }
  }).mount('#app');
  </script>
</body>
</html>
